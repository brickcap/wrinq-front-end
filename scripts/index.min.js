function getStore(e,t){var n=database.transaction([e],t),r=n.objectStore(e);return r}function addToStore(e,t,n){var r=getStore(n,"readwrite");return t&&r.put(e,t),t||r.put(e),r}function createObjectStore(e,t,n){return e.objectStoreNames.contains(t)?null:n?e.createObjectStore(t):n?null:e.createObjectStore(t,{autoIncrement:!0})}function check(e){btnSend.disabed=!0;if(!e.value)return;var t={url:'/checkuser?name="'+e.value+'"',method:"GET",successCallback:function(e){if(JSON.parse(e).available)return;btnSend.disabled=!1}};helpers.ajax(t)}function searchTerm(e,t){var n=JSON.parse(localStorage.getItem(e)),r=n.length,i=0,s="";for(i;i<r;i++)console.log(n[i]),console.log(t),n[i].indexOf(t)!=-1&&e==="tags"&&(s+='<li class="details" data-tag="'+n[i]+'"onclick="showTag(this)">'+n[i]+"</li>"),n[i].indexOf(t)!=-1&&e==="sent"&&(s+='<li class="details" data-to="'+n[i]+'"onclick="showConversation(this)">'+n[i]+"</li>");return s}function autoGrow(e){e.scrollHeight>e.clientHeight&&(e.style.height=e.scrollHeight+"px")}function addCommentBox(e){e.parentNode.innerHTML=domElements.commentBox}function removeCommentBox(e){e.parentNode.parentNode.innerHTML='<button  onclick = "addCommentBox(this)">reply</button>'}function send(e){var t=document.getElementsByName("to")[0].value,n=document.getElementsByName("tag")[0].value,r=document.createElement("div");r.innerHTML=document.getElementsByName("message")[0].value;var i=r.innerText||r.textContent;if(!t||!i)e.parentNode.parentNode.innerHTML+="<p>The message can not be empty</p>";var s={to:t,m:{t:n,m:i}},o=buildProfile(t,s);socket.send(JSON.stringify(o));var u=helpers.saveMessage(buildDate(s),t);save(t,"sent"),n&&save(n,"tags"),messages.innerHTML=domElements.incomingMessage(u)+messages.innerHTML,showActivity();return}function reply(e){var t=e.parentNode.parentNode.parentNode,n=t.getAttribute("data-to"),r=t.getAttribute("data-tags"),i=helpers.id("sendError");i&&helpers.hide(i);var s=document.getElementsByName("message")[0].value;if(!s){e.parentNode.parentNode.innerHTML+="<p>The message can not be empty</p>";return}var o={to:n,m:{t:r,m:s}},u=buildProfile(n,o);socket.send(JSON.stringify(u));var a=helpers.saveMessage(buildDate(o),n);save(n,"sent"),r&&save(r,"tags"),messages.innerHTML=domElements.incomingMessage(a)+messages.innerHTML,showActivity();return}function buildProfile(e,t){if(!prf)return t.m.p=null,t;var n={n:prf.name,pic:prf.pic,a:prf.about};return t.m.p=n,t}function save(e,t){var n=localStorage.getItem(t);if(!n&&e){var r=[];r.push(e),n=JSON.stringify(r),localStorage.setItem(t,n);return}if(n&&e){var i=JSON.parse(n);i.indexOf(e)<0&&(i.push(e),localStorage.setItem(t,JSON.stringify(i)));return}}function buildDate(e){var t=new Date;return e.month=t.getMonth()+1,e.day=t.getDate(),e.year=t.getFullYear(),e.min=t.getMinutes(),e.hour=t.getHours(),e.sec=t.getSeconds(),e}function showConversation(e){var t=e.getAttribute("data-to")||e.parentNode.parentNode.parentNode.getAttribute("data-to")||e.parentNode.parentNode.getAttribute("data-to");sIn.value="",helpers.id("searchResult").innerHTML="",helpers.hideM([sendMessage,messages,tagDiv]),helpers.show(conversation),buildMessages(t)}function buildMessages(e){var t=getStore("messages","readonly"),n=t.index("between"),r=IDBKeyRange.only(e),i=n.openCursor(r,"prev"),s=0,o="";i.onsuccess=function(t){var n=t.target.result;n&&s!=10&&(n.continue(),o+=domElements.incomingMessage(n.value),s++);if(!n||s===10){var r='<h1 class="center-div">Your conversation with '+e+"</h1>";conversation.innerHTML=r+o,menu.scrollIntoView()}}}function showTag(e){sIn.value="",helpers.id("searchResult").innerHTML="";var t=e.getAttribute("data-tag")||e.parentNode.parentNode.getAttribute("data-tag");helpers.hideM([sendMessage,messages,conversation]),helpers.show(tagDiv),buildTag(t)}function buildTag(e){console.log(e);var t=getStore("messages","readonly"),n=t.index("tag"),r=IDBKeyRange.only(e),i=n.openCursor(r,"prev"),s=0,o="";i.onsuccess=function(t){var n=t.target.result;n&&s!=10&&(n.continue(),s++,o+=domElements.incomingMessage(n.value));if(!n||s===10){var r='<h1 class="center-div">Messages Tagged as '+e+"</h1>";tagDiv.innerHTML=r+o,menu.scrollIntoView()}}}function messageBox(){helpers.hideM([messages,conversation,tagDiv]),sendMessage.innerHTML=domElements.sendMessage,helpers.show(sendMessage)}function showActivity(){helpers.hideM([sendMessage,conversation,tagDiv]),helpers.show(messages),menu.scrollIntoView()}var helpers={id:function(e){return document.getElementById(e)},show:function(e){e.style.display="block"},hide:function(e){e.style.display="none"},hideM:function(e){var t=e.length,n=0;for(n;n<t;n++)e[n].style.display="none"},clearHtml:function(e){e.innerHTML=""},serializeTextFields:function(e){var t=0,n=e.elements.length-1,r="";for(t;t<n;t++){var i=e.elements[t].name,s=e.elements[t].value,o=i+"="+s+"&";r+=encodeURI(o)}return r},buildAjaxPostObject:function(e,t){var n={data:t,method:"POST"};return e.id==="loginForm"&&(n.url="/login",n.successCallback=logincallback.successCallback,n.errorCallback=logincallback.errorCallback),e.id==="signUpForm"&&(n.url="/createuser",n.successCallback=createcallback.successCallback,n.errorCallback=createcallback.errorCallback),n},ajax:function(e){var t=new XMLHttpRequest;t.open(e.method,e.url,!0),t.onreadystatechange=function(){t.status===404&&e.errorCallback();if(t.status!=200||t.readyState!=4)return;e.successCallback(t.responseText)},t.send(e.data)},successCallback:function(e){var t=addToStore({session:e},"sess","application");t.transaction.oncomplete=function(){checkSession()}},output:function(e){var t=/(\n{2}|\r{2})/g,n=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?*=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,r=e.replace(t,"<br/><br/>").replace(n,function(e){return e.indexOf(".jpg")>0||e.indexOf(".jpeg")>0||e.indexOf(".png")>0||e.indexOf(".gif")>0?'<br/><img src="'+e+'"><br/>':'<a href="'+e+'">'+e+"</a>"});return r},saveMessage:function(e,t){t&&(e.f=t);var n=addToStore(e,null,"messages");return e},addProfile:function(e){return e.hasOwnProperty("m")?e.m.p?e:(e.m.p={},e.m.p.u=e.f,e):e},buildMessages:function(){var e=getStore("messages","readonly"),t=0,n="";e.openCursor(null,"prev").onsuccess=function(e){var r=e.target.result;if(t===10||!r){if(!t)return;if(t){messages.innerHTML=n,showActivity();return}}r&&(n+=domElements.incomingMessage(r.value),r.continue(),t++)}},humanDate:function(e){var t=Math.floor((new Date-e)/1e3),n=Math.floor(t/31536e3);return n>1?n+"y":(n=Math.floor(t/2592e3),n>1?n+"m":(n=Math.floor(t/86400),n>1?n+"d":(n=Math.floor(t/3600),n>1?n+"h":(n=Math.floor(t/60),n>1?n+" min":Math.floor(t)+"s"))))}},signUp=helpers.id("signup"),login=helpers.id("login"),splashDiv=helpers.id("splash"),formDiv=helpers.id("formDiv"),app=helpers.id("app"),appBody=helpers.id("appBody"),appMessage=helpers.id("appMessage"),messages=helpers.id("messages"),sendMessage=helpers.id("sendMessage"),sendBtn=helpers.id("sendBtn"),btnReply=helpers.id("btnReply"),messageDiv=helpers.id("messageDiv"),conversation=helpers.id("conversation"),tagDiv=helpers.id("tag"),sIn=helpers.id("search"),menu=helpers.id("menu"),openRequest=indexedDB.open("wrinq",1),prf,database,socket;openRequest.onupgradeneeded=function(e){database=e.target.result,createObjectStore(database,"profile",!1).createIndex("name","u",{unique:!0});var t=createObjectStore(database,"messages",!1);t.createIndex("tag","m.t",{unique:!1}),t.createIndex("between","f"),t.createIndex("profile","m.p.u",{unique:!1}),createObjectStore(database,"application",!0)},openRequest.onsuccess=function(e){database=e.target.result,checkSession()},openRequest.onerror=function(e){console.log(e)};var checkSession=function(){var e=getStore("application","readonly"),t=e.get("sess");t.onsuccess=function(e){if(!e.target.result){helpers.show(splashDiv);return}helpers.hide(splashDiv),helpers.hide(formDiv);var t=getStore("profile","readonly"),n=t.get("master");n.onsuccess=function(e){if(!e.target.result){messageDiv.innerHTML='<a href="/editprofile.html">create a profile</a>';return}prf=e.target.result},helpers.buildMessages(),socket=socketManager(e.target.result.session)}},socketManager=function(e){var t=new WebSocket("ws://localhost:3000/websocket/"+e);return t.onopen=function(e){t.send(JSON.stringify({ret:1})),helpers.show(app)},t.onmessage=function(e){var n=JSON.parse(e.data);if(n.hasOwnProperty("msgs")&&n.msgs.length>0){var r=n.msgs,i=r.length,s=0;for(s;s<i;s++){var o=JSON.parse(r[s]),u=helpers.addProfile(o);helpers.saveMessage(u)}var a=i>=1?" 1 message was sent while you were offline":" messages were sent while you were offline";helpers.id("unread").innerHTML=i+a,t.send(JSON.stringify({delmsg:1}));return}if(n.hasOwnProperty("m")){helpers.addProfile(n),helpers.saveMessage(n),messages.innerHTML=domElements.incomingMessage(n)+messages.innerHTML;return}},t.onerror=function(e){messageDiv.innerHTML+='<p id="error-message">Could not connect to the server.Try refreshing.</p>',helpers.show(app)},t},logincallback={successCallback:helpers.successCallback,errorCallback:function(){var e=helpers.id("message");e.innerHTML="Login failed."}},createcallback={successCallback:helpers.successCallback,errorCallback:function(){var e=helpers.id("message");e.innerHTML="This action could not be completed"}},domElements={signUpForm:'<form  id ="signUpForm" onsubmit="submitAjax(event,this)"><p><input type="text" name="username" value="" placeholder= "username" onblur="checkUser(this)" onfocus = "clearMessages()" required/></p><p><input type="password" name="password" value="" placeholder="password"  required/></p><p><input type="submit" id="submitButton"  value="sign up" disabled/></p></form><p id ="message"></p><p><span class ="underline-spans" onclick = "loginClick()">or login<span></p>',loginForm:'<form  method="POST" id="loginForm" onsubmit="submitAjax(event,this)"><p><input type="text" name="username" value="" placeholder="username"  required/></p><p><input type="password" name="password" value="" placeholder="password"  required/></p><p><input type="submit" id="submitButton" name="" value="login"/></p></form><p id= "message"></p><p ><span class ="underline-spans" onclick ="signUpClick()">or sign-up<span></p>',commentBox:'<div class="box"><p><textarea rows="5" name="message" placeholder="your message" onkeyup="autoGrow(this)"></textarea></p></div> <span><button type="button" onclick="reply(this)" id="btnReply disabled">post</button></span><span><button type="button" onclick="removeCommentBox(this)">cancel</button>',contact:function(e){var t='<div class="contacts"><h1 style="text-align:center;">contacts</h1></div>';return t},sendMessage:'<div  class="box"><p><input type="text" name="to" placeholder="to" onblur="check(this)"/></p><p><textarea rows="5" placeholder="your message" onkeyup="autoGrow(this)" name="message"></textarea></p><p><input type="text" name="tag" placeholder="tag"/></p></div> <span><button type="button" onclick="send(this)" id="btnSend" disabled>post</button></span>',incomingMessage:function(e){var t=e.day+"-"+e.month+"-"+e.year+" ",n=e.min>10?e.min:"0"+e.min,r=e.sec>10?e.sec:"0"+e.sec,i=e.hour>=12?e.hour-12+":"+n+"PM":e.hour+":"+n+" AM",s=helpers.humanDate(new Date(e.year,e.month-1,e.day,e.hour,parseInt(e.min),parseInt(e.sec))),o=function(){var t=e.hasOwnProperty("to")?"<span onclick='showConversation(this)'>you,<em class='details'>"+e.to+"</em>:</span>":"<span onclick='showConversation(this)' class='details'><em>"+e.f+":"+"</em></span>";return e.m.p?e.m.p.hasOwnProperty("pic")?e.m.p.hasOwnProperty("pic")?"<img  class='img-span' src="+e.m.p.pic+"</img>"+t:"":t:t},u=e.hasOwnProperty("to")?"":"<p><button onclick='addCommentBox(this)'>reply</button></p>",a=helpers.output(e.m.m),f=e.m.t?e.m.t:"";f&&save(f,"tags");var l='<div class="messageBody" data-to="'+e.f+'" data-tag="'+f+'"><hr style="border-color:#fff"/><p><span>'+o()+'</span><span class="date">'+s+"</span></p><span>"+a+'</span><p><span class="details" onclick="showTag(this)">'+f+"</span></p>"+u+"</div></div>";return l}},signUpClick=function(){helpers.hide(splashDiv),formDiv.innerHTML=domElements.signUpForm,helpers.show(formDiv)},loginClick=function(){helpers.hide(splashDiv),formDiv.innerHTML=domElements.loginForm,helpers.show(formDiv)},submitAjax=function(e,t){e.preventDefault();var n=helpers.serializeTextFields(t);helpers.ajax(helpers.buildAjaxPostObject(t,n))},checkUser=function(e){var t=helpers.id("submitButton"),n=helpers.id("message");t.disabled=!0;if(!e.value)return;var r={url:'/checkuser?name="'+e.value+'"',method:"GET",successCallback:function(e){if(JSON.parse(e).available){t.disabled=!1;return}t.disabled=!0,n.innerHTML="The username is taken"}};helpers.ajax(r)},clearMessages=function(){var e=helpers.id("message");e.innerHTML=""},showUnread=function(e){helpers.hide(e),helpers.buildMessages()},search=function(e){var t=e.value,n=helpers.id("searchResult");n.innerHTML="";if(t.charAt(0)==="@"&&t.length>=2){console.log("search user");var r=searchTerm("sent",t.slice(1,t.length).trim());n.innerHTML='<ul style="list-style:none">'+r+"</ul>"}if(t.charAt(0)==="#"&&t.length>=2){var i=searchTerm("tags",t.slice(1,t.length).trim());console.log(i),n.innerHTML='<ul style="list-style:none">'+i+"</ul>"}}