function getStore(e,t){var n=database.transaction([e],t),r=n.objectStore(e);return r}function addToStore(e,t,n){var r=getStore(n,"readwrite");return t&&r.put(e,t),t||r.put(e),r}function createObjectStore(e,t,n){return e.objectStoreNames.contains(t)?null:n?e.createObjectStore(t):n?null:e.createObjectStore(t,{autoIncrement:!0})}function check(e){btnSend.disabled=!0;if(!e.value)return;var t={url:"/checkuser?name="+e.value,method:"GET",successCallback:function(e){if(JSON.parse(e).available)return;btnSend.disabled=!1}};helpers.ajax(t)}function searchTerm(e,t){var n=JSON.parse(localStorage.getItem(e)),r=n.length,i=0,s="";for(i;i<r;i++)n[i].indexOf(t)!=-1&&e==="tags"&&(s+='<li class="details" data-tag="'+n[i]+'"onclick="showTag(this)">'+n[i]+"</li>"),n[i].indexOf(t)!=-1&&e==="sent"&&(s+='<li class="details" data-to="'+n[i]+'"onclick="showConversation(this)">'+n[i]+"</li>");return s}function autoGrow(e){e.scrollHeight>e.clientHeight&&(e.style.height=e.scrollHeight+"px")}function addCommentBox(e){e.parentNode.innerHTML=domElements.commentBox}function removeCommentBox(e){e.parentNode.parentNode.innerHTML='<button  onclick = "addCommentBox(this)">reply</button>'}function send(e){var t=document.getElementsByName("to")[0].value,n=document.getElementsByName("tag")[0].value,r=document.createElement("div");r.innerHTML=document.getElementsByName("message")[0].value;var i=r.innerText||r.textContent;if(!i){e.parentNode.parentNode.innerHTML+="<p>The message can not be empty</p>";return}var s={to:t,m:{t:n,m:i}},o=buildProfile(t,s);socket.send(JSON.stringify(o));var u=helpers.saveMessage(buildDate(s),t);save(t,"sent"),n&&save(n,"tags"),messages.innerHTML=domElements.incomingMessage(u)+messages.innerHTML,showActivity();return}function reply(e){var t=e.parentNode.parentNode.parentNode,n=t.getAttribute("data-to"),r=t.getAttribute("data-tag"),i=helpers.id("sendError");i&&helpers.hide(i);var s=document.createElement("div");s.innerHTML=document.getElementsByName("reply")[0].value;var o=s.innerText||s.textContent;if(!o){e.parentNode.parentNode.innerHTML+="<p>The message can not be empty</p>";return}var u={to:n,m:{t:r,m:o}},a=buildProfile(n,u);socket.send(JSON.stringify(a)),e.parentNode.parentNode.innerHTML='<button  onclick = "addCommentBox(this)">reply</button>';var f=helpers.saveMessage(buildDate(u),n);messages.innerHTML=domElements.incomingMessage(f)+messages.innerHTML,showActivity(),menu.scrollIntoView();return}function buildProfile(e,t){if(!prf)return t.m.p=null,t;var n={n:prf.name,pic:prf.pic,a:prf.about};return t.m.p=n,t}function save(e,t){var n=localStorage.getItem(t);if(!n&&e){var r=[];r.push(e),n=JSON.stringify(r),localStorage.setItem(t,n);return}if(n&&e){var i=JSON.parse(n);i.indexOf(e)<0&&(i.push(e),localStorage.setItem(t,JSON.stringify(i)));return}}function buildDate(e){var t=new Date;return e.month=t.getMonth()+1,e.day=t.getDate(),e.year=t.getFullYear(),e.min=t.getMinutes(),e.hour=t.getHours(),e.sec=t.getSeconds(),e}function showConversation(e){var t=e.getAttribute("data-to")||e.parentNode.parentNode.parentNode.getAttribute("data-to")||e.parentNode.parentNode.getAttribute("data-to");sIn.value="",helpers.id("searchResult").innerHTML="",helpers.hideM([sendMessage,messages,tagDiv,contactDiv]),helpers.show(conversation),buildMessages(t)}function buildMessages(e){var t=getStore("messages","readonly"),n=t.index("between"),r=IDBKeyRange.only(e),i=n.openCursor(r,"prev"),s=0,o="";i.onsuccess=function(t){var n=t.target.result;n&&s!=20&&(n.continue(),o+=domElements.incomingMessage(n.value),s++);if(!n||s===20){var r='<span class="details" data-to="'+e+'" onclick=showContact(this)>'+e+"</span>",i='<h1 class="center-div">Your conversation with '+r+"</h1>",u=s===20?'<p style="text-align:center" class="details" onclick="moreBIndex(1,\''+e+"',this)"+'">more</p>':"";conversation.innerHTML=i+o+u,menu.scrollIntoView()}}}function moreBIndex(e,t,n){helpers.hide(n);var r=getStore("messages","readonly"),i=r.index("between"),s=0,o=[],u=IDBKeyRange.only(t),a=i.openCursor(u,"prev"),f=e*20,l=20*(e+1);a.onsuccess=function(n){var r=n.target.result;if(s===l||!r){console.log(r);var i=s>=l?function(){return e++,'<p style="text-align:center" class="details" onclick="moreTagsIndex('+e+",'"+t+"',this)"+'">more</p>'}():"";conversation.innerHTML=conversation.innerHTML+o.join("")+i;return}r&&(s>=f&&o.push(domElements.incomingMessage(r.value)),r.continue(),s++)}}function showTag(e){sIn.value="",helpers.id("searchResult").innerHTML="";var t=e.getAttribute("data-tag")||e.parentNode.parentNode.getAttribute("data-tag");helpers.hideM([sendMessage,messages,conversation,contactDiv]),helpers.show(tagDiv),buildTag(t)}function buildTag(e){var t=getStore("messages","readonly"),n=t.index("tag"),r=IDBKeyRange.only(e),i=n.openCursor(r,"prev"),s=0,o="";i.onsuccess=function(t){var n=t.target.result;n&&s!=20&&(n.continue(),s++,o+=domElements.incomingMessage(n.value));if(!n||s===20){var r='<h1 class="center-div">Messages Tagged as '+e+"</h1>",i=s===20?'<p style="text-align:center" class="details" onclick="moreTagsIndex(1,\''+e+"',this)"+'">more</p>':"";tagDiv.innerHTML=r+o+i,menu.scrollIntoView()}}}function moreTagsIndex(e,t,n){helpers.hide(n);var r=getStore("messages","readonly"),i=r.index("tag"),s=0,o=[],u=IDBKeyRange.only(t),a=i.openCursor(u,"prev"),f=e*20,l=20*(e+1);a.onsuccess=function(n){var r=n.target.result;if(s===l||!r){console.log(r);var i=s>=l?function(){return e++,'<p style="text-align:center" class="details" onclick="moreTagsIndex('+e+",'"+t+"',this)"+'">more</p>'}():"";tagDiv.innerHTML=tagDiv.innerHTML+o.join("")+i;return}r&&(s>=f&&o.push(domElements.incomingMessage(r.value)),r.continue(),s++)}}function showContact(e){helpers.hideM([sendMessage,messages,conversation]),helpers.show(contactDiv);var t=e.parentNode.parentNode.parentNode.getAttribute("data-to")||e.getAttribute("data-to");buildContactProfile(t,e)}function buildContactProfile(e,t){var n=getStore("messages","readonly"),r=n.index("profile"),i=IDBKeyRange.only(e),s=r.openCursor(i,"prev");s.onsuccess=function(t){var n=t.target.result.value;contactDiv.innerHTML="",n.m.p.hasOwnProperty("pic")&&(contactDiv.innerHTML=contactDiv.innerHTML+"<img src = '"+n.m.p.pic+"'/>"),contactDiv.innerHTML=contactDiv.innerHTML+'<p class="details" onclick="showConversation(this)" data-to="'+e+'">user: '+e+"</p>",n.m.p.hasOwnProperty("n")&&(contactDiv.innerHTML=contactDiv.innerHTML+"<p>Name: "+n.m.p.n+"</p>");if(n.m.p.hasOwnProperty("a")){var r=n.m.p.a,i=document.createElement("div");i.innerHTML=r;var s=i.innerText||i.textContent;contactDiv.innerHTML=contactDiv.innerHTML+"<p>about: "+helpers.output(s)+"</p><hr>"}}}function messageBox(){helpers.hideM([messages,conversation,tagDiv,contactDiv]),sendMessage.innerHTML=domElements.sendMessage,helpers.show(sendMessage)}function showActivity(){helpers.hideM([sendMessage,conversation,tagDiv,contactDiv]),helpers.show(messages),menu.scrollIntoView()}function morePagesIndex(e,t){helpers.hide(t);var n=getStore("messages","readonly"),r=0,i=[];console.log(typeof i),n.openCursor().onsuccess=function(t){var n=t.target.result;e>20&&n.skip(20-e),console.log(n.key);if(r===e-1||!n){if(!r)return;if(r){var s=r===20?'<p style="text-align:center" class="details" onclick="morePagesIndex('+n.key+',this)">more</p>':"";messages.innerHTML=messages.innerHTML+i.reverse().join("")+s;return}}n&&(i.push(domElements.incomingMessage(n.value)),n.continue(),r++)}}var helpers={id:function(e){return document.getElementById(e)},show:function(e){e.style.display="block"},hide:function(e){e.style.display="none"},hideM:function(e){var t=e.length,n=0;for(n;n<t;n++)e[n].style.display="none"},clearHtml:function(e){e.innerHTML=""},serializeTextFields:function(e){var t=0,n=e.elements.length-1,r="";for(t;t<n;t++){var i=e.elements[t].name,s=e.elements[t].value,o=i+"="+s+"&";r+=encodeURI(o)}return r},buildAjaxPostObject:function(e,t){var n={data:t,method:"POST"};return e.id==="loginForm"&&(n.url="/login",n.successCallback=logincallback.successCallback,n.errorCallback=logincallback.errorCallback),e.id==="signUpForm"&&(n.url="/createuser",n.successCallback=createcallback.successCallback,n.errorCallback=createcallback.errorCallback),n},ajax:function(e){var t=new XMLHttpRequest;t.open(e.method,e.url,!0),t.onreadystatechange=function(){t.status===404&&e.errorCallback();if(t.status!=200||t.readyState!=4)return;e.successCallback(t.responseText)},t.send(e.data)},successCallback:function(e){console.log(e);var t=JSON.parse(e),n=Object.keys(t)[0],r=addToStore({session:n},"sess","application");r.transaction.oncomplete=function(){localStorage.setItem("user",t[n]),checkSession()}},output:function(e){var t=/(\n{2}|\r{2})/g,n=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?*=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,r=e.replace(t,"<br>").replace(n,function(e){return e.indexOf(".jpg")>0||e.indexOf(".jpeg")>0||e.indexOf(".png")>0||e.indexOf(".gif")>0?'<br/><img src="'+e+'"><br/>':'<a href="'+e+'">'+e+"</a>"});return r},saveMessage:function(e,t){t&&(e.f=t);var n=addToStore(e,null,"messages");return e},addProfile:function(e){return e.hasOwnProperty("m")?e.m.p?(e.m.p&&!e.m.p.u&&(e.m.p.u=e.f),e):(e.m.p={},e.m.p.u=e.f,e):e},buildMessages:function(){var e=getStore("messages","readonly"),t=0,n="";e.openCursor(null,"prev").onsuccess=function(e){var r=e.target.result;if(t===20||!r){if(!t)return;if(t){var i=t===20?'<p style="text-align:center" class="details" onclick="morePagesIndex('+r.key+',this)">more</p>':"";messages.innerHTML=n+i,showActivity();return}}r&&(n+=domElements.incomingMessage(r.value),r.continue(),t++)}},humanDate:function(e){var t=Math.floor((new Date-e)/1e3),n=Math.floor(t/31536e3);return n>1?n+"y":(n=Math.floor(t/2592e3),n>1?n+"m":(n=Math.floor(t/86400),n>1?n+"d":(n=Math.floor(t/3600),n>1?n+"h":(n=Math.floor(t/60),n>1?n+" min":Math.floor(t)+"s"))))}},signUp=helpers.id("signup"),login=helpers.id("login"),splashDiv=helpers.id("splash"),formDiv=helpers.id("formDiv"),app=helpers.id("app"),appBody=helpers.id("appBody"),appMessage=helpers.id("appMessage"),messages=helpers.id("messages"),sendMessage=helpers.id("sendMessage"),sendBtn=helpers.id("sendBtn"),btnReply=helpers.id("btnReply"),messageDiv=helpers.id("messageDiv"),conversation=helpers.id("conversation"),tagDiv=helpers.id("tag"),sIn=helpers.id("search"),menu=helpers.id("menu"),contactDiv=helpers.id("contact"),openRequest=indexedDB.open("wrinq",1),prf,database,socket;openRequest.onupgradeneeded=function(e){database=e.target.result,createObjectStore(database,"profile",!1).createIndex("name","u",{unique:!0});var t=createObjectStore(database,"messages",!1);t.createIndex("tag","m.t",{unique:!1}),t.createIndex("between","f"),t.createIndex("profile","m.p.u"),createObjectStore(database,"application",!0)},openRequest.onsuccess=function(e){database=e.target.result,checkSession()},openRequest.onerror=function(e){console.log(e)};var checkSession=function(){var e=getStore("application","readonly"),t=e.get("sess");t.onsuccess=function(e){if(!e.target.result){helpers.show(splashDiv);return}helpers.hide(splashDiv),helpers.hide(formDiv);var t=getStore("profile","readonly"),n=t.get("master"),r=localStorage.getItem("user");n.onsuccess=function(e){if(!e.target.result){messageDiv.innerHTML='<a href="/editprofile.html">create a profile '+r+"</a>";return}messageDiv.innerHTML='<a href="/editprofile.html">'+r+"</a>",prf=e.target.result},helpers.buildMessages(),socket=socketManager(e.target.result.session)}},socketManager=function(e){var t=new WebSocket("ws://localhost:3000/websocket/"+e);return t.onopen=function(e){t.send(JSON.stringify({ret:1})),helpers.show(app)},t.onmessage=function(e){var n=JSON.parse(e.data);if(n.hasOwnProperty("msgs")&&n.msgs.length>0){var r=n.msgs,i=r.length,s=0;for(s;s<i;s++){var o=JSON.parse(r[s]),u=helpers.addProfile(o);helpers.saveMessage(u)}var a=i>1?" messages were sent while you were offline":" message was sent while you were offline";helpers.id("unread").innerHTML=i+a,t.send(JSON.stringify({delmsg:1}));return}if(n.hasOwnProperty("m")){helpers.addProfile(n),helpers.saveMessage(n),messages.innerHTML=domElements.incomingMessage(n)+messages.innerHTML;return}},t.onerror=function(e){messageDiv.innerHTML+='<p id="error-message">Could not connect to the server.Try refreshing.</p>',helpers.show(app)},t},createcallback={successCallback:helpers.successCallback,errorCallback:function(){var e=helpers.id("message");e.innerHTML="This action could not be completed"}},domElements={signUpForm:'<form  id ="signUpForm" onsubmit="submitAjax(event,this)"><p><input type="text" name="username" value="" placeholder= "username" onblur="checkUser(this)" onfocus = "clearMessages()" required/></p><p><input type="password" name="password" value="" placeholder="password"  required/></p><p><input type="submit" id="submitButton"  value="sign up" disabled/></p></form><p id ="message"></p><p><span class ="underline-spans" onclick = "loginClick()">or login<span></p>',loginForm:'<form  method="POST" id="loginForm" onsubmit="submitAjax(event,this)"><p><input type="text" name="username" value="" placeholder="username"  required/></p><p><input type="password" name="password" value="" placeholder="password"  required/></p><p><input type="submit" id="submitButton" name="" value="login"/></p></form><p id= "message"></p><p ><span class ="underline-spans" onclick ="signUpClick()">or sign-up<span></p>',commentBox:'<div class="box"><p><textarea rows="5" name="reply" placeholder="your message" onkeyup="autoGrow(this)"></textarea></p></div> <span><button type="button" onclick="reply(this)" id="btnReply disabled">post</button></span><span><button type="button" onclick="removeCommentBox(this)">cancel</button>',contact:function(e){var t='<div class="contacts"><h1 style="text-align:center;">contacts</h1></div>';return t},sendMessage:'<div  class="box"><p><input type="text" name="to" placeholder="to" onblur="check(this)"/></p><p><textarea rows="5" placeholder="your message" onkeyup="autoGrow(this)" name="message"></textarea></p><p><input type="text" name="tag" placeholder="tag"/></p></div> <span><button type="button" onclick="send(this)" id="btnSend" disabled>post</button></span>',incomingMessage:function(e){var t=function(){var t=e.hasOwnProperty("to")?"<span onclick='showConversation(this)'>me, <em class='details'>"+e.to+"</em></span>":"<span onclick='showConversation(this)' class='details'><em>"+e.f+"</em></span>";return e.m.p?e.m.p.hasOwnProperty("pic")?e.m.p.hasOwnProperty("pic")?e.hasOwnProperty("to")?'<a href="/editprofile.html"><img  class="img-span" src="'+e.m.p.pic+'"/></a>'+t:'<img onclick="showContact(this)"  class="img-span" src="'+e.m.p.pic+'"/>'+t:"":t:t},n=helpers.output(e.m.m),r=e.m.t?e.m.t:"";r&&save(r,"tags"),save(e.f,"sent");var i='<div class="messageBody" data-to="'+e.f+'" data-tag="'+r+'"><hr style="border-color:#fff; margin-bottom:0px;"/><p><span>'+t()+"</span></p><span>"+n+'</span><p><span class="details" onclick="showTag(this)">'+r+'</span></p><p><button onclick="addCommentBox(this)">reply</button></p></div></div>';return i}},signUpClick=function(){helpers.hide(splashDiv),formDiv.innerHTML=domElements.signUpForm,helpers.show(formDiv)},loginClick=function(){helpers.hide(splashDiv),formDiv.innerHTML=domElements.loginForm,helpers.show(formDiv)},submitAjax=function(e,t){e.preventDefault();var n=helpers.serializeTextFields(t);helpers.ajax(helpers.buildAjaxPostObject(t,n))},checkUser=function(e){var t=helpers.id("submitButton"),n=helpers.id("message");t.disabled=!0;if(!e.value)return;var r={url:"/checkuser?name="+e.value,method:"GET",successCallback:function(e){if(JSON.parse(e).available){t.disabled=!1;return}t.disabled=!0,n.innerHTML="The username is taken"}};helpers.ajax(r)},clearMessages=function(){var e=helpers.id("message");e.innerHTML=""},showUnread=function(e){helpers.hide(e),helpers.buildMessages()},search=function(e){var t=e.value,n=helpers.id("searchResult");n.innerHTML="";if(t.charAt(0)==="@"&&t.length>=2){var r=searchTerm("sent",t.slice(1,t.length).trim());n.innerHTML='<ul style="list-style:none">'+r+"</ul>"}if(t.charAt(0)==="#"&&t.length>=2){var i=searchTerm("tags",t.slice(1,t.length).trim());n.innerHTML='<ul style="list-style:none">'+i+"</ul>"}}