function getStore(e,t){var n=database.transaction([e],t),r=n.objectStore(e);return r}function addToAppStore(e,t){var n=getStore("application","readwrite");t&&n.add(e,t),t||n.add(e)}function addObjectStore(e,t,n){if(e.objectStoreNames.contains(t))return;n&&e.createObjectStore(t),n||e.createObjectStore(t,{autoIncrement:!0})}var openRequest=indexedDB.open("wrinq",1),database;openRequest.onupgradeneeded=function(e){database=e.target.result,addObjectStore(database,"profile",!1),addObjectStore(database,"messages",!1),addObjectStore(database,"application",!0)},openRequest.onsuccess=function(e){database=e.target.result,checkSession()},openRequest.onerror=function(e){console.log(e)};var checkSession=function(){var e=getStore("application","readonly"),t=e.get("sess");t.onsuccess=function(e){if(!e.target.result){helpers.show(splashDiv);return}helpers.hide(splashDiv),socketManager(e.target.result.session)}},socketManager=function(e){var t=new WebSocket("ws://localhost:3000/websocket/"+e);return t.onopen=function(e){console.log(e)},t.onmessage=function(e){},t.onerror=function(e){console.log(e),helpers.show(splashDiv)},t},logincallback={successCallback:function(e){helpers.hide(formDiv),addToAppStore({session:e},"sess"),socketManager(e)},errorCallback:function(){var e=helpers.id("message");e.innerHTML="Login failed."}},createcallback={successCallback:function(e){helpers.hide(formDiv)},errorCallback:function(){var e=helpers.id("message");e.innerHTML="This action could not be completed"}},helpers={id:function(e){return document.getElementById(e)},show:function(e){e.style.display="block"},hide:function(e){e.style.display="none"},clearHtml:function(e){e.innerHTML=""},serializeTextFields:function(e){var t=0,n=e.elements.length-1,r="";for(t;t<n;t++){var i=e.elements[t].name,s=e.elements[t].value,o=i+"="+s+"&";r+=encodeURI(o)}return r},buildAjaxPostObject:function(e,t){var n={data:t,method:"POST"};return e.id==="loginForm"&&(n.url="/login",n.successCallback=logincallback.successCallback,n.errorCallback=logincallback.errorCallback),e.id==="signUpForm"&&(n.url="/createuser",n.successCallback=createcallback.successCallback,n.errorCallback=createcallback.errorCallback),n},ajax:function(e){var t=new XMLHttpRequest;t.open(e.method,e.url,!0),t.onreadystatechange=function(){t.status===404&&e.errorCallback();if(t.status!=200||t.readyState!=4)return;e.successCallback(t.responseText)},t.send(e.data)}},domElements={signUpForm:'<form  id ="signUpForm" onsubmit="submitAjax(event,this)"><p><input type="text" name="username" value="" placeholder= "username" onfocusout="checkUser(this)" onfocus = "clearMessages()" required/></p><p><input type="password" name="password" value="" placeholder="password"  required/></p><p><input type="submit" id="submitButton"  value="sign up" disabled/></p></form><p id ="message"></p><p><span class ="underline-spans" onclick = "loginClick()">or login<span></p>',loginForm:'<form  method="POST" id="loginForm" onsubmit="submitAjax(event,this)"><p><input type="text" name="username" value="" placeholder="username"  required/></p><p><input type="password" name="password" value="" placeholder="password"  required/></p><p><input type="submit" id="submitButton" name="" value="login"/></p></form><p id= "message"></p><p ><span class ="underline-spans" onclick ="signUpClick()">or sign-up<span></p>'},signUp=helpers.id("signup"),login=helpers.id("login"),splashDiv=helpers.id("splash"),formDiv=helpers.id("formDiv"),signUpClick=function(){helpers.hide(splashDiv),formDiv.innerHTML=domElements.signUpForm},loginClick=function(){helpers.hide(splashDiv),formDiv.innerHTML=domElements.loginForm},submitAjax=function(e,t){e.preventDefault();var n=helpers.serializeTextFields(t);helpers.ajax(helpers.buildAjaxPostObject(t,n))},checkUser=function(e){var t=helpers.id("submitButton"),n=helpers.id("message");t.disabled=!0;if(!e.value)return;var r={url:'/checkuser?name="'+e.value+'"',method:"GET",successCallback:function(e){if(JSON.parse(e).available){t.disabled=!1;return}t.disabled=!0,n.innerHTML="The username is taken"}};helpers.ajax(r)},clearMessages=function(){var e=helpers.id("message");e.innerHTML=""}