function getStore(e,t){var n=database.transaction([e],t),r=n.objectStore(e);return r}function addToStore(e,t,n){var r=getStore(n,"readwrite");return t&&r.put(e,t),t||r.put(e),r}function createObjectStore(e,t,n){return e.objectStoreNames.contains(t)?null:n?e.createObjectStore(t):n?null:e.createObjectStore(t,{autoIncrement:!0})}function check(e){btnSend.disabed=!0;if(!e.value)return;var t={url:'/checkuser?name="'+e.value+'"',method:"GET",successCallback:function(e){if(JSON.parse(e).available)return;btnSend.disabled=!1}};helpers.ajax(t)}function autoGrow(e){e.scrollHeight>e.clientHeight&&(e.style.height=e.scrollHeight+"px")}function addCommentBox(e){e.parentNode.innerHTML=domElements.commentBox}function removeCommentBox(e){e.parentNode.parentNode.innerHTML='<button  onclick = "addCommentBox(this)">reply</button>'}function send(e){var t=document.getElementsByName("to")[0].value,n=document.getElementsByName("tag")[0].value,r=document.createElement("div");r.innerHTML=document.getElementsByName("message")[0].value;var i=r.innerText||r.textContent;if(!t||!i)e.parentNode.parentNode.innerHTML+="<p>The message can not be empty</p>";var s={to:t,m:{t:n,m:i}},o=buildProfile(t,s);socket.send(JSON.stringify(o)),helpers.saveMessage(buildDate(s),t),save(t,"sent"),n&&save(n,"tags");return}function reply(e){var t=e.parentNode.parentNode.parentNode.parentNode,n=t.getAttribute("data-to"),r=t.getAttribute("data-tags"),i=helpers.id("sendError");i&&helpers.hide(i);var s=document.getElementsByName("message")[0].value;if(!s){e.parentNode.parentNode.innerHTML+="<p>The message can not be empty</p>";return}var o={to:n,m:{t:r,m:s,w:n}},u=buildProfile(n,o);socket.send(JSON.stringify(u)),helpers.saveMessage(buildDate(o),n),save(n,"sent"),r&&save(r,"tags")}function buildProfile(e,t){var n=localStorage.getItem("sent");if(!n){if(!prf)return t;var r={n:prf.name,pic:prf.pic,a:prf.about};return t.m.p=r,t}return t}function save(e,t){var n=localStorage.getItem(t);if(!n){n=JSON.stringify([e]),console.log(n),localStorage.setItem(t,n);return}if(n){var r=JSON.parse(n);r.indexOf(e)||(r.push(e),localStorage.setItem(t,JSON.stringify(n)));return}}function buildDate(e){var t=new Date;return e.month=t.getMonth()+1,e.day=t.getDay(),e.year=t.getFullYear(),e.min=t.getMinutes(),e.hour=t.getHours(),e.sec=t.getSeconds(),e}function showConversation(e){var t=e.parentNode.parentNode.parentNode.getAttribute("data-to");helpers.hide(sendMessage),helpers.hide(messages),helpers.show(conversation);var n=getStore("profile","readonly"),r=n.index("name"),i=r.get(t);i.onsuccess=function(e){var n=e.target.result;buildMessages(t,n)}}function buildMessages(e,t){var n=getStore("messages","readonly"),r=n.index("between"),i=IDBKeyRange.only(e),s=r.openCursor(i,"prev"),o=0,u="";s.onsuccess=function(n){var r=n.target.result;r&&o!=10&&(r.continue(),r.value.m.p=t,u+=domElements.incomingMessage(r.value),o++);if(!r||o===10){var i='<h1 class="center-div"> Conversation with '+e+"</h1>";conversation.innerHTML=i+u}}}function messageBox(){helpers.hide(appMessage),helpers.hide(messages),helpers.hide(conversation),sendMessage.innerHTML=domElements.sendMessage,helpers.show(sendMessage)}function showActivity(){helpers.hide(sendMessage),helpers.hide(conversation),helpers.show(messages)}var helpers={id:function(e){return document.getElementById(e)},show:function(e){e.style.display="block"},hide:function(e){e.style.display="none"},clearHtml:function(e){e.innerHTML=""},serializeTextFields:function(e){var t=0,n=e.elements.length-1,r="";for(t;t<n;t++){var i=e.elements[t].name,s=e.elements[t].value,o=i+"="+s+"&";r+=encodeURI(o)}return r},buildAjaxPostObject:function(e,t){var n={data:t,method:"POST"};return e.id==="loginForm"&&(n.url="/login",n.successCallback=logincallback.successCallback,n.errorCallback=logincallback.errorCallback),e.id==="signUpForm"&&(n.url="/createuser",n.successCallback=createcallback.successCallback,n.errorCallback=createcallback.errorCallback),n},ajax:function(e){var t=new XMLHttpRequest;t.open(e.method,e.url,!0),t.onreadystatechange=function(){t.status===404&&e.errorCallback();if(t.status!=200||t.readyState!=4)return;e.successCallback(t.responseText)},t.send(e.data)},successCallback:function(e){var t=addToStore({session:e},"sess","application");t.transaction.oncomplete=function(){checkSession()}},output:function(e){var t=/(\n|\r)/g,n=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?*=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,r=e.replace(t,"<br/>").replace(n,function(e){return e.indexOf(".jpg")>0||e.indexOf(".jpeg")>0||e.indexOf(".png")>0||e.indexOf(".gif")>0?'<br/><img src="'+e+'"><br/>':'<a href="'+e+'">'+e+"</a>"});return r},saveMessage:function(e,t){t&&(e.f=t);var n=addToStore(e,null,"messages");return}},signUp=helpers.id("signup"),login=helpers.id("login"),splashDiv=helpers.id("splash"),formDiv=helpers.id("formDiv"),app=helpers.id("app"),appBody=helpers.id("appBody"),appMessage=helpers.id("appMessage"),messages=helpers.id("messages"),sendMessage=helpers.id("sendMessage"),sendBtn=helpers.id("sendBtn"),btnReply=helpers.id("btnReply"),messageDiv=helpers.id("messageDiv"),conversation=helpers.id("conversation"),tag=helpers.id("tag"),openRequest=indexedDB.open("wrinq",1),prf,database,socket;openRequest.onupgradeneeded=function(e){database=e.target.result,createObjectStore(database,"profile",!1).createIndex("name","u",{unique:!0});var t=createObjectStore(database,"messages",!1);t.createIndex("tag","t",{unique:!1}),t.createIndex("between","f"),createObjectStore(database,"application",!0)},openRequest.onsuccess=function(e){database=e.target.result,checkSession()},openRequest.onerror=function(e){console.log(e)};var checkSession=function(){var e=getStore("application","readonly"),t=e.get("sess");t.onsuccess=function(e){if(!e.target.result){helpers.show(splashDiv);return}helpers.hide(splashDiv),helpers.hide(formDiv);var t=getStore("profile","readonly"),n=t.get("master");n.onsuccess=function(e){if(!e.target.result){messageDiv.innerHTML='<a href="/editprofile.html">create a profile</a>';return}prf=e.target.result};var r=getStore("messages","readonly"),i=0;r.openCursor(null,"prev").onsuccess=function(e){var t=e.target.result;if(i===10||!t){if(!i){var n=helpers.id("appMessage");n.innerHTML="<p>No recent activity</p>",helpers.show(n)}return}t&&(t.continue(),i++)},socket=socketManager(e.target.result.session)}},socketManager=function(e){var t=new WebSocket("ws://localhost:3000/websocket/"+e);return t.onopen=function(e){helpers.show(app)},t.onmessage=function(e){var t=JSON.parse(e.data);if(!t.hasOwnProperty("m"))return;helpers.saveMessage(t);var n=t.m.hasOwnProperty("p"),r=getStore("profile","readonly"),i=r.index("name"),s=i.get(t.f);s.onsuccess=function(e){var r=e.target.result;if(n){messages.innerHTML=domElements.incomingMessage(t)+messages.innerHTML,t.m.p.u=t.f,addToStore(t.m.p,null,"profile");return}t.m.p=r,messages.innerHTML=domElements.incomingMessage(t)+messages.innerHTML;return}},t.onerror=function(e){messageDiv.innerHTML+='<p id="error-message">Could not connect to the server.Try refreshing.</p>',helpers.show(app)},t},logincallback={successCallback:helpers.successCallback,errorCallback:function(){var e=helpers.id("message");e.innerHTML="Login failed."}},createcallback={successCallback:helpers.successCallback,errorCallback:function(){var e=helpers.id("message");e.innerHTML="This action could not be completed"}},domElements={signUpForm:'<form  id ="signUpForm" onsubmit="submitAjax(event,this)"><p><input type="text" name="username" value="" placeholder= "username" onblur="checkUser(this)" onfocus = "clearMessages()" required/></p><p><input type="password" name="password" value="" placeholder="password"  required/></p><p><input type="submit" id="submitButton"  value="sign up" disabled/></p></form><p id ="message"></p><p><span class ="underline-spans" onclick = "loginClick()">or login<span></p>',loginForm:'<form  method="POST" id="loginForm" onsubmit="submitAjax(event,this)"><p><input type="text" name="username" value="" placeholder="username"  required/></p><p><input type="password" name="password" value="" placeholder="password"  required/></p><p><input type="submit" id="submitButton" name="" value="login"/></p></form><p id= "message"></p><p ><span class ="underline-spans" onclick ="signUpClick()">or sign-up<span></p>',commentBox:'<div class="box"><p><textarea rows="5" name="message" placeholder="your message" onkeyup="autoGrow(this)"></textarea></p></div> <span><button type="button" onclick="reply(this)" id="btnReply disabled">post</button></span><span><button type="button" onclick="removeCommentBox(this)">cancel</button>',contact:function(e){var t='<div class="contacts"><h1 style="text-align:center;">contacts</h1></div>';return t},sendMessage:'<div  class="box"><p><input type="text" name="to" placeholder="to" onblur="check(this)"/></p><p><textarea rows="5" placeholder="your message" onkeyup="autoGrow(this)" name="message"></textarea></p><p><input type="text" name="tag" placeholder="tag"/></p></div> <span><button type="button" onclick="send(this)" id="btnSend" disabled>post</button></span>',incomingMessage:function(e){var t=e.day+"-"+e.month+"-"+e.year+" ",n=e.min>10?e.min:"0"+e.min,r=e.hour>=12?e.hour-12+":"+n+"PM":e.hour+":"+n+" AM",i=function(){if(!e.m.p)return"[<span onclick='showConversation(this)' class='details'><em>"+e.f+":</em></span> ";var t=e.m.p.hasOwnProperty("n")?e.m.p.n:e.f;return e.m.p.hasOwnProperty("pic")?e.m.p.hasOwnProperty("pic")?"<img  class='img-span' src="+e.m.p.pic+"</img>[<span class='details' onclick='showConversation(this)'>"+t+"</span>":"":"[<span onclick='showConversation(this)' class='details'><em>"+t+":</em></span> "},s=helpers.output(e.m.m),o=e.m.t?e.m.t:"",u='<div class="messageBody" data-to="'+e.f+'" data-tag="'+o+'"><hr style="border-color:#fff"/><p><span>'+i()+"</span><span> <em>"+t+r+"</em>]</span></p><span>"+s+'</span><p><span class="details">'+o+'</span></p> <p><button onclick = "addCommentBox(this)">reply</button></p> </div></div>';return u}},signUpClick=function(){helpers.hide(splashDiv),formDiv.innerHTML=domElements.signUpForm,helpers.show(formDiv)},loginClick=function(){helpers.hide(splashDiv),formDiv.innerHTML=domElements.loginForm,helpers.show(formDiv)},submitAjax=function(e,t){e.preventDefault();var n=helpers.serializeTextFields(t);helpers.ajax(helpers.buildAjaxPostObject(t,n))},checkUser=function(e){var t=helpers.id("submitButton"),n=helpers.id("message");t.disabled=!0;if(!e.value)return;var r={url:'/checkuser?name="'+e.value+'"',method:"GET",successCallback:function(e){if(JSON.parse(e).available){t.disabled=!1;return}t.disabled=!0,n.innerHTML="The username is taken"}};helpers.ajax(r)},clearMessages=function(){var e=helpers.id("message");e.innerHTML=""}