function getStore(e,t){var n=database.transaction([e],t),r=n.objectStore(e);return r}function addToStore(e,t,n){var r=getStore(n,"readwrite");return t&&r.add(e,t),t||r.add(e),r}function createObjectStore(e,t,n){if(e.objectStoreNames.contains(t))return;n&&e.createObjectStore(t),n||e.createObjectStore(t,{autoIncrement:!0})}function autoGrow(e){e.scrollHeight>e.clientHeight&&(e.style.height=e.scrollHeight+"px")}function addCommentBox(e){e.parentNode.innerHTML=domElements.commentBox}function removeCommentBox(e){e.parentNode.parentNode.innerHTML='<span  class="action-item" title="reply" onclick = "addCommentBox(this)">&lt;\\&gt;</span>'}function send(e){var t=helpers.id("sendError");t&&helpers.hide(t);var n=document.getElementsByName("to")[0].value,r=document.getElementsByName("tag")[0].value,i=document.getElementsByName("message")[0].value;if(!n||!i){e.parentNode.parentNode.innerHTML+='<p id="sendError">There must be a valid username and a non empty message</p>';return}console.log(n+" "+i+" "+r)}function messageBox(){helpers.hide(appMessage),helpers.hide(messages),sendMessage.innerHTML=domElements.sendMessage,console.log(sendMessage),helpers.show(sendMessage)}function showActivity(){helpers.hide(sendMessage),helpers.show(messages)}var helpers={id:function(e){return document.getElementById(e)},show:function(e){e.style.display="block"},hide:function(e){e.style.display="none"},clearHtml:function(e){e.innerHTML=""},serializeTextFields:function(e){var t=0,n=e.elements.length-1,r="";for(t;t<n;t++){var i=e.elements[t].name,s=e.elements[t].value,o=i+"="+s+"&";r+=encodeURI(o)}return r},buildAjaxPostObject:function(e,t){var n={data:t,method:"POST"};return e.id==="loginForm"&&(n.url="/login",n.successCallback=logincallback.successCallback,n.errorCallback=logincallback.errorCallback),e.id==="signUpForm"&&(n.url="/createuser",n.successCallback=createcallback.successCallback,n.errorCallback=createcallback.errorCallback),n},ajax:function(e){var t=new XMLHttpRequest;t.open(e.method,e.url,!0),t.onreadystatechange=function(){t.status===404&&e.errorCallback();if(t.status!=200||t.readyState!=4)return;e.successCallback(t.responseText)},t.send(e.data)},successCallback:function(e){var t=addToStore({session:e},"sess","application");t.transaction.oncomplete=function(){checkSession()}},output:function(e){var t=/\B(@[^ ]+)\s/g,n=/\B(#[^ ]+)\s/g,r=/(\n|\r)/g,i=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,s=e.replace(t,'<span class="underline-spans">$1</span>').replace(n,'<span class="underline-spans">$1</span>').replace(r,"<br/>").replace(i,function(e){return e.indexOf(".jpg")>0||e.indexOf(".jpeg")>0||e.indexOf(".png")>0||e.indexOf(".gif")>0?'<img src="'+e+'">'+"<br/>":'<a href="'+e+'">'+e+"</a>"+"<br/>"});return console.log(s),s}},signUp=helpers.id("signup"),login=helpers.id("login"),splashDiv=helpers.id("splash"),formDiv=helpers.id("formDiv"),app=helpers.id("app"),appBody=helpers.id("appBody"),appMessage=helpers.id("appMessage"),messages=helpers.id("messages"),sendMessage=helpers.id("sendMessage"),openRequest=indexedDB.open("wrinq",1),database,socket;openRequest.onupgradeneeded=function(e){database=e.target.result,createObjectStore(database,"profile",!1),createObjectStore(database,"messages",!1),createObjectStore(database,"application",!0)},openRequest.onsuccess=function(e){database=e.target.result,checkSession()},openRequest.onerror=function(e){console.log(e)};var checkSession=function(){var e=getStore("application","readonly"),t=e.get("sess");t.onsuccess=function(e){if(!e.target.result){helpers.show(splashDiv);return}helpers.hide(splashDiv),helpers.hide(formDiv);var t=getStore("profile","readonly"),n=t.get("master");n.onsuccess=function(e){if(!e.target.result){messageDiv.innerHTML='<a href="/editprofile.html">create a profile</a>';return}};var r=getStore("messages","readonly");r.openCursor(null,"prev").onsuccess=function(e){var t=e.target.result,n=0;if(!t||n===10){appMessage.innerHTML="<p>No recent activity</p>",helpers.show(appMessage);return}n++,t.continue()},socket=socketManager(e.target.result.session)}},socketManager=function(e){var t=new WebSocket("ws://localhost:3000/websocket/"+e);return t.onopen=function(e){helpers.show(app)},t.onmessage=function(e){},t.onerror=function(e){messageDiv.innerHTML+='<p id="error-message">Could not connect to the server.Try refreshing.</p>',console.log(app),helpers.show(app)},t},logincallback={successCallback:helpers.successCallback,errorCallback:function(){var e=helpers.id("message");e.innerHTML="Login failed."}},createcallback={successCallback:helpers.successCallback,errorCallback:function(){var e=helpers.id("message");e.innerHTML="This action could not be completed"}},domElements={signUpForm:'<form  id ="signUpForm" onsubmit="submitAjax(event,this)"><p><input type="text" name="username" value="" placeholder= "username" onfocusout="checkUser(this)" onfocus = "clearMessages()" required/></p><p><input type="password" name="password" value="" placeholder="password"  required/></p><p><input type="submit" id="submitButton"  value="sign up" disabled/></p></form><p id ="message"></p><p><span class ="underline-spans" onclick = "loginClick()">or login<span></p>',loginForm:'<form  method="POST" id="loginForm" onsubmit="submitAjax(event,this)"><p><input type="text" name="username" value="" placeholder="username"  required/></p><p><input type="password" name="password" value="" placeholder="password"  required/></p><p><input type="submit" id="submitButton" name="" value="login"/></p></form><p id= "message"></p><p ><span class ="underline-spans" onclick ="signUpClick()">or sign-up<span></p>',commentBox:'<div class="box"><p><input type="text" name="" placeholder="@to"/></p><p><textarea rows="5" name="" placeholder="message" onkeyup="autoGrow(this)"></textarea></p><p><input type="text" placeholder="optional #tag"/></p></div> <span><button type="button">post</button></span><span><button type="button" onclick="removeCommentBox(this)">cancel</button>',contact:function(e){var t='<div class="contacts"><h1 style="text-align:center;">contacts</h1></div>';return t},addContact:'<div class="center-div"><input type="text" placeholder="username of the contact"/><p><button>send request</button></p></div>',sendMessage:'<div  class="box"><p><input type="text" name="to" placeholder="@to"/></p><p><textarea rows="5" placeholder="message" onkeyup="autoGrow(this)" name="message"></textarea></p><p><input type="text" name="tag" placeholder="optional #tag"/></p></div> <span><button type="button" onclick="send(this)">post</button></span>'},signUpClick=function(){helpers.hide(splashDiv),formDiv.innerHTML=domElements.signUpForm,helpers.show(formDiv)},loginClick=function(){helpers.hide(splashDiv),formDiv.innerHTML=domElements.loginForm,helpers.show(formDiv)},submitAjax=function(e,t){e.preventDefault();var n=helpers.serializeTextFields(t);helpers.ajax(helpers.buildAjaxPostObject(t,n))},checkUser=function(e){var t=helpers.id("submitButton"),n=helpers.id("message");t.disabled=!0;if(!e.value)return;var r={url:'/checkuser?name="'+e.value+'"',method:"GET",successCallback:function(e){if(JSON.parse(e).available){t.disabled=!1;return}t.disabled=!0,n.innerHTML="The username is taken"}};helpers.ajax(r)},clearMessages=function(){var e=helpers.id("message");e.innerHTML=""}